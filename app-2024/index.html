<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>App 2024</title>
  <script type="module">
    class App extends HTMLElement {
      static get observedAttributes() {
        return ["url"];
      }

      #addClickHandler = (id, handler) => {
        document.getElementById(id).addEventListener("click", handler);
      }

      setUpButtons() {
        this.#addClickHandler("showButton", this.getAndShowAddresses);
        this.#addClickHandler("saveButton", this.saveAddress);

        this.firstName = document.getElementById("firstName");
        this.lastName = document.getElementById("lastName");
        this.detailForm = document.getElementById("detail");
        this.self = this;
      }

      firstAddress;
      firstName;
      lastName;
      self;

      /**
       * @type {HTMLFormElement}
       * */
      detailForm;

      async getAndShowAddresses() {
        const response = await fetch("http://localhost:20241/addresses");
        const addresses = await response.json();

        const addressListElement = document.getElementById("addresses");
        const addressText = addresses.map(a => `${a.firstName} ${a.lastName}`).join("\n");

        const addressesText = document.createTextNode(addressText);

        addressListElement.textContent = "";
        addressListElement.appendChild(addressesText);

        this.firstAddress = addresses[0];

        this.firstName.value = this.firstAddress.firstName;
        this.lastName.value = this.firstAddress.lastName;
      }

      async saveAddress(e) {
        e.preventDefault();

        const self = document.getElementById("detail");

        const isValid = self.detailForm.reportValidity();

        if (isValid) {
          self.firstAddress.firstName = self.firstName.value;
          self.firstAddress.lastName = self.lastName.value;

          const putResponse = await fetch(`http://localhost:20241/addresses/${firstAddress.id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(self.firstAddress),
          });

          if (putResponse.ok) {
            alert("Object saved.");
          }
          else {
            alert("Error while saving object.");
          }
        }
      }

      async connectedCallback() {
        this.setUpButtons();
        await this.getAndShowAddresses();
      }

      attributeChangedCallback(name, oldValue, newValue) {
        // Wird nur für Attribut "url" ausgeführt
      }
    }

    customElements.define("app-2024", App);
  </script>

  <style>
    html {
      --standard-spacing: 10px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    form {
      display: grid;
      grid-template-columns: minmax(150px, auto) 1fr;
      gap: var(--standard-spacing);
    }

    form *:nth-child(odd) {
      justify-self: end;
    }

    form input {
      align-self: center;
      padding: var(--standard-spacing);
    }

    form label {
      align-self: center;
    }
  </style>
</head>

<body>
  <app-2024 url="http://localhost:20241/addresses">
    <button id="showButton">Get and show addresses</button>
    <button id="changeAttribute">Update Attribute</button>

    <div id="addresses" style="background: cornsilk; min-height: 100px;">
    </div>

    <h1>Address details</h1>
    <form id="detail">
      <label>First name</label>
      <input list="firstNames" placeholder="vorname" id="firstName" required>

      <label>Last name</label>
      <input id="lastName" required>

      <button id="saveButton">Save address</button>

      <datalist id="firstNames">
        <option value="Joe"></option>
        <option value="Jane"></option>
        <option value="John"></option>
        <option value="Jessica"></option>
      </datalist>
    </form>
  </app-2024>

</body>

</html>